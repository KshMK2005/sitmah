import mongoose from 'mongoose';
import fs from 'fs';
import path from 'path';

console.log('üöÄ Configurando MongoDB Atlas para el sistema de temas...\n');

// Funci√≥n para crear archivo .env si no existe
const createEnvFile = () => {
  const envPath = path.join(process.cwd(), '.env');
  
  if (!fs.existsSync(envPath)) {
    const envContent = `# Configuraci√≥n del servidor
PORT=5000
NODE_ENV=development

# Base de datos MongoDB Atlas
# Reemplaza esta URL con tu cadena de conexi√≥n real de MongoDB Atlas
MONGODB_URI=mongodb+srv://sitmah_user:tu_contrase√±a@cluster.mongodb.net/sitmah?retryWrites=true&w=majority

# En producci√≥n, Vercel proporcionar√° MONGODB_URI autom√°ticamente
`;
    
    fs.writeFileSync(envPath, envContent);
    console.log('‚úÖ Archivo .env creado');
    console.log('üìù Por favor, edita el archivo .env y reemplaza la URL de MongoDB Atlas con tu cadena de conexi√≥n real');
  } else {
    console.log('‚úÖ Archivo .env ya existe');
  }
};

// Funci√≥n para verificar la conexi√≥n a MongoDB Atlas
const testAtlasConnection = async (uri) => {
  try {
    console.log('üîó Probando conexi√≥n a MongoDB Atlas...');
    
    const conn = await mongoose.connect(uri, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      serverSelectionTimeoutMS: 10000,
      socketTimeoutMS: 45000,
    });
    
    console.log(`‚úÖ Conectado exitosamente a: ${conn.connection.host}`);
    console.log(`üìä Base de datos: ${conn.connection.name}`);
    
    await mongoose.disconnect();
    return true;
  } catch (error) {
    console.error('‚ùå Error conectando a MongoDB Atlas:');
    console.error('   Mensaje:', error.message);
    console.error('   C√≥digo:', error.code);
    
    if (error.code === 'ENOTFOUND') {
      console.log('\nüí° Soluci√≥n: Verifica que la cadena de conexi√≥n sea correcta');
      console.log('   Aseg√∫rate de reemplazar "tu_contrase√±a" con tu contrase√±a real');
    } else if (error.code === 'ENOTFOUND') {
      console.log('\nüí° Soluci√≥n: Verifica tu conexi√≥n a internet');
    } else if (error.message.includes('Authentication failed')) {
      console.log('\nüí° Soluci√≥n: Verifica el username y password');
    } else if (error.message.includes('Network access denied')) {
      console.log('\nüí° Soluci√≥n: Ve a "Network Access" en Atlas y agrega tu IP');
    }
    
    return false;
  }
};

// Funci√≥n para configurar el sistema de temas en Atlas
const setupThemeSystem = async (uri) => {
  try {
    console.log('\nüé® Configurando sistema de temas en MongoDB Atlas...');
    
    const conn = await mongoose.connect(uri, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    
    // Esquema de configuraci√≥n
    const configuracionSchema = new mongoose.Schema({
      nombre: { type: String, required: true, unique: true },
      valor: { type: String, required: true },
      descripcion: { type: String },
      fechaActualizacion: { type: Date, default: Date.now }
    });
    
    const Configuracion = mongoose.model('Configuracion', configuracionSchema);
    
    // Verificar si ya existe la configuraci√≥n del tema
    const temaExistente = await Configuracion.findOne({ nombre: 'temaGlobal' });
    
    if (temaExistente) {
      console.log('‚úÖ Configuraci√≥n del tema ya existe en Atlas:');
      console.log(`   - Tema actual: ${temaExistente.valor}`);
      console.log(`   - √öltima actualizaci√≥n: ${temaExistente.fechaActualizacion}`);
    } else {
      console.log('üîÑ Creando configuraci√≥n del tema en Atlas...');
      
      const nuevaConfig = await Configuracion.create({
        nombre: 'temaGlobal',
        valor: 'normal',
        descripcion: 'Tema global de la aplicaci√≥n'
      });
      
      console.log('‚úÖ Configuraci√≥n del tema creada en Atlas:');
      console.log(`   - Tema: ${nuevaConfig.valor}`);
      console.log(`   - Descripci√≥n: ${nuevaConfig.descripcion}`);
    }
    
    // Listar todas las configuraciones
    const todasConfigs = await Configuracion.find();
    console.log('\nüìã Configuraciones en Atlas:');
    if (todasConfigs.length === 0) {
      console.log('   No hay configuraciones');
    } else {
      todasConfigs.forEach((config, index) => {
        console.log(`   ${index + 1}. ${config.nombre}: ${config.valor}`);
      });
    }
    
    await mongoose.disconnect();
    return true;
  } catch (error) {
    console.error('‚ùå Error configurando sistema de temas:', error);
    await mongoose.disconnect();
    return false;
  }
};

// Funci√≥n principal
const main = async () => {
  console.log('üìã Pasos para configurar MongoDB Atlas:\n');
  console.log('1. Ve a MongoDB Atlas (mongodb.com/atlas)');
  console.log('2. Crea un cluster gratuito');
  console.log('3. Configura un usuario y contrase√±a');
  console.log('4. Configura acceso de red (Allow Access from Anywhere)');
  console.log('5. Obt√©n la cadena de conexi√≥n');
  console.log('6. Reemplaza la URL en el archivo .env\n');
  
  // Crear archivo .env
  createEnvFile();
  
  // Verificar si hay una URL de Atlas configurada
  const envPath = path.join(process.cwd(), '.env');
  if (fs.existsSync(envPath)) {
    const envContent = fs.readFileSync(envPath, 'utf8');
    const mongoUriMatch = envContent.match(/MONGODB_URI=(.+)/);
    
    if (mongoUriMatch && !mongoUriMatch[1].includes('tu_contrase√±a')) {
      const atlasUri = mongoUriMatch[1].trim();
      console.log('üîç URL de MongoDB Atlas encontrada en .env');
      
      // Probar conexi√≥n
      const connected = await testAtlasConnection(atlasUri);
      if (connected) {
        // Configurar sistema de temas
        await setupThemeSystem(atlasUri);
        console.log('\nüéâ ¬°Configuraci√≥n completada! El sistema de temas est√° listo para usar.');
      }
    } else {
      console.log('\n‚ö†Ô∏è  Por favor, edita el archivo .env y reemplaza la URL de MongoDB Atlas');
      console.log('   Ejemplo: MONGODB_URI=mongodb+srv://usuario:contrase√±a@cluster.mongodb.net/sitmah');
    }
  }
  
  console.log('\nüìö Para m√°s informaci√≥n, consulta el archivo atlas-config.md');
};

main().catch(console.error); 