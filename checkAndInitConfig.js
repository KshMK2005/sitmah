import mongoose from 'mongoose';
import dotenv from 'dotenv';

// Cargar variables de entorno
dotenv.config();

// Conectar a MongoDB Atlas
const connectDB = async () => {
  try {
    console.log('üîó Conectando a MongoDB Atlas...');
    console.log('URI de conexi√≥n:', process.env.MONGODB_URI ? 'Configurada' : 'No configurada');
    
    const conn = await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/sitmah', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      serverSelectionTimeoutMS: 10000,
      socketTimeoutMS: 45000,
    });
    
    console.log(`‚úÖ MongoDB Atlas conectado: ${conn.connection.host}`);
    console.log('üìä Base de datos:', conn.connection.name);
    return true;
  } catch (error) {
    console.error('‚ùå Error conectando a MongoDB Atlas:');
    console.error('Mensaje:', error.message);
    console.error('C√≥digo:', error.code);
    return false;
  }
};

// Esquema de configuraci√≥n
const configuracionSchema = new mongoose.Schema({
  nombre: { type: String, required: true, unique: true },
  valor: { type: String, required: true },
  descripcion: { type: String },
  fechaActualizacion: { type: Date, default: Date.now }
});

const Configuracion = mongoose.model('Configuracion', configuracionSchema);

// Funci√≥n para verificar y crear configuraci√≥n
const checkAndInitConfig = async () => {
  try {
    console.log('\nüîç Verificando configuraci√≥n existente...');
    
    // Verificar si existe la configuraci√≥n del tema
    const temaExistente = await Configuracion.findOne({ nombre: 'temaGlobal' });
    
    if (temaExistente) {
      console.log('‚úÖ Configuraci√≥n del tema encontrada:');
      console.log(`   - Nombre: ${temaExistente.nombre}`);
      console.log(`   - Valor: ${temaExistente.valor}`);
      console.log(`   - Descripci√≥n: ${temaExistente.descripcion}`);
      console.log(`   - √öltima actualizaci√≥n: ${temaExistente.fechaActualizacion}`);
    } else {
      console.log('‚ùå Configuraci√≥n del tema no encontrada');
      console.log('üîÑ Creando configuraci√≥n inicial...');
      
      // Crear configuraci√≥n inicial del tema
      const nuevaConfig = await Configuracion.create({
        nombre: 'temaGlobal',
        valor: 'normal',
        descripcion: 'Tema global de la aplicaci√≥n'
      });
      
      console.log('‚úÖ Configuraci√≥n del tema creada exitosamente:');
      console.log(`   - Nombre: ${nuevaConfig.nombre}`);
      console.log(`   - Valor: ${nuevaConfig.valor}`);
      console.log(`   - Descripci√≥n: ${nuevaConfig.descripcion}`);
    }

    // Listar todas las configuraciones
    console.log('\nüìã Todas las configuraciones en la base de datos:');
    const todasConfigs = await Configuracion.find();
    if (todasConfigs.length === 0) {
      console.log('   No hay configuraciones en la base de datos');
    } else {
      todasConfigs.forEach((config, index) => {
        console.log(`   ${index + 1}. ${config.nombre}: ${config.valor}`);
      });
    }

    console.log('\n‚úÖ Verificaci√≥n completada exitosamente');
    return true;
  } catch (error) {
    console.error('‚ùå Error verificando configuraci√≥n:', error);
    return false;
  }
};

// Funci√≥n para probar la API
const testAPI = async () => {
  try {
    console.log('\nüß™ Probando API de configuraci√≥n...');
    
    const baseURL = process.env.NODE_ENV === 'production' 
      ? 'https://tu-app.vercel.app/api' 
      : 'http://localhost:5000/api';
    
    console.log(`üåê URL base: ${baseURL}`);
    
    // Probar obtener configuraci√≥n
    const response = await fetch(`${baseURL}/configuracion/temaGlobal`);
    if (response.ok) {
      const config = await response.json();
      console.log('‚úÖ API funcionando correctamente:');
      console.log(`   - Tema actual: ${config.valor}`);
    } else {
      console.log('‚ùå Error en la API:', response.status, response.statusText);
    }
  } catch (error) {
    console.error('‚ùå Error probando API:', error.message);
  }
};

// Ejecutar el script
const main = async () => {
  console.log('üöÄ Iniciando verificaci√≥n de configuraci√≥n en MongoDB Atlas...\n');
  
  const connected = await connectDB();
  if (!connected) {
    console.log('‚ùå No se pudo conectar a MongoDB Atlas');
    process.exit(1);
  }
  
  const success = await checkAndInitConfig();
  if (success) {
    await testAPI();
  }
  
  await mongoose.disconnect();
  console.log('\n‚úÖ Script completado');
};

main().catch(console.error); 